/**
 * 
 */

// ê²€ìƒ‰ ë„ì„œ ë¦¬ìŠ¤íŠ¸ì™€ í˜ì´ì§€ ì •ë³´
const bookSearchListBasic = (urlStype, urlSword, currentSortType) => {
	  
	  console.log("bookSearchListBasic ì‹¤í–‰" + urlStype + " " + urlSword + " " + currentSortType);
	  
	  // ë„ì„œê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
	  $.ajax({
		  /*= url : /BookDam/BookSearchList.do */
		  url : `${mypath}/BookSearchList.do`,
		  data : JSON.stringify({
			  page : currentPage,
			  stype : urlStype, 
			  sword : urlSword,
			  sortType : currentSortType,
			  mem_mail : memMail  
		  }),
		  method : 'post',
		  contentType: 'application/json;charset=utf-8', /* ìƒëµê°€ëŠ¥ */
		  
		  success: function(res) {  /*resëŠ” bookSearchView.jspì˜ ê²°ê³¼ = ì‹¤ì œ ë°ì´í„°X, response ê°ì²´!*/
			console.log(res);
			            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ
            if(res.datas && res.datas.length > 0) {
                
                // ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ í‘œì‹œ
                $('#searchResults').show();
                $('#noResults').hide();
                $('#loading').hide();
				
                // ì´ ê±´ìˆ˜ ì—…ë°ì´íŠ¸
                $('#totalCount').text(res.totalCount);
				
				// í˜„ì¬ ì •ë ¬ ìƒíƒœ ìœ ì§€
				$('#sortType').val(currentSortType);
				
				
				// ===== ìƒˆë¡œ ì¶”ê°€í•¨: URL ì—…ë°ì´íŠ¸ (AJAX ì„±ê³µ í›„) =====
				updateURLAfterSearch();
				
				
                // ì¶œë ¥ëª¨ì–‘ ë§Œë“¤ê¸°
                let code = '<div class="book-list">';
                
                $.each(res.datas, function(i, book) {
                    
                    // ì´ë¯¸ì§€ ì²˜ë¦¬ (ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€)
                    let bookImage = book.cover_img ? 
                        `<img src="${book.cover_img}" alt="${book.book_title}" class="book-image">` : 
                        `<div class="book-image">ğŸ“–<br>ì´ë¯¸ì§€</div>`;
                    
                    // ê°€ê²© í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
                    let formattedPrice = book.book_price ? 
                        book.book_price.toLocaleString() + 'ì›' : 'ê°€ê²©ì •ë³´ì—†ìŒ';
                    
                    // ë§ˆì¼ë¦¬ì§€ ê³„ì‚° (ì¼ë°˜ì€ 5%ì ë¦½)
                    let mileage = book.book_price ? Math.floor(book.book_price * res.mileageRate) : 0;
                    
					let mileageInfo = ""; // ì¶œë ¥ìš© ë³€ìˆ˜
					if(res.memGrade !== "ë¹„íšŒì›") {
						// ë¡œê·¸ì¸ í•œ íšŒì›
						let ratePercent = (res.mileageRate * 100);
						mileageInfo = `<div class="book-mileage">ì ë¦½ì˜ˆì •: ${mileage.toLocaleString()}ë§ˆì¼ë¦¬ì§€ (${ratePercent}%)</div>`;
					} else {
						// ë¹„íšŒì›
						mileageInfo = `<div class="book-mileage non-member">ë¡œê·¸ì¸ í›„ ë§ˆì¼ë¦¬ì§€ ì ë¦½ ê°€ëŠ¥</div>`;
					}

                    // ì¶œê°„ì¼ í¬ë§·
                    let pubDate = book.book_pubdate ? 
                        new Date(book.book_pubdate).toLocaleDateString() : '';
                    
                    code += `
                        <div class="book-item" onclick="goToBookDetail(${book.book_no})">
                            ${bookImage}
                            <div class="book-info">
                                <div class="book-title">${book.book_title}</div>
                                <div class="book-author">${book.book_author}</div>
                                <div class="book-publisher">${book.publisher || ''}</div>
                                <div class="book-publish-date">${pubDate}</div>
                                <div class="book-rating">
									<img id="img-star" src="${mypath}/images/star2.png" alt="${mypath}/images/star2.png">
                                    <span class="stars">${(book.avgRating).toFixed(1)}</span>
                                    <span class="reviewCount">(${book.reviewCount})</span>
                                </div>
                                <div class="book-price">${formattedPrice}</div>
								${mileageInfo}
                            </div>
                            <div class="book-actions">
                                <button class="btn btn-cart">ì¥ë°”êµ¬ë‹ˆ</button>
                                <button class="btn btn-buy">ë°”ë¡œêµ¬ë§¤</button>
                            </div>
                        </div>
                    `;
                });
                
                code += '</div>';
                
                // bookSearch.jspì˜ id="result"ì— ì¶œë ¥
                $('#result').html(code);
                
            } else {
                // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
                $('#searchResults').hide();
                $('#noResults').show();
                $('#loading').hide();
            }
            
            // í˜ì´ì§€ ì •ë³´ ì¶œë ¥
            pager = pageList(res.sp, res.ep, res.tp);
            $('#pagelist').html(pager);
        },
        error: function(xhr) {
            $('#loading').hide();
            alert("ì˜¤ë¥˜ : " + xhr.status);
        },
        dataType: 'json'
    });
}

// ì¹´í…Œê³ ë¦¬ë³„ ì±… ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
const loadCategoryList = (category, page, sortType) => {
	console.log('AJAX ìš”ì²­:', {category: category, page: page, sortType: sortType}); // ë””ë²„ê·¸
	
	  // ë„ì„œ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
	  $.ajax({
		  /*= url : /BookDam/BookSearchList.do */
		  url : `${mypath}/BookCategoryList.do`,
		  method : 'get',
		  data : {
			  category: category,
			  page: page,	  
			  sortType : currentSortType  			  
		  },
		  success: function(res) {  /*resëŠ” bookSearchView.jspì˜ ê²°ê³¼ = ì‹¤ì œ ë°ì´í„°X, response ê°ì²´!*/
			console.log(res);
			            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ
            if(res.datas && res.datas.length > 0) {

                // ì´ ê±´ìˆ˜ ì—…ë°ì´íŠ¸
                $('#totalCount').text(res.totalCount);
				
				// í˜„ì¬ ì •ë ¬ ìƒíƒœ ìœ ì§€
				$('#sortType').val(currentSortType);
				
				
				// ===== ìƒˆë¡œ ì¶”ê°€í•¨: URL ì—…ë°ì´íŠ¸ (AJAX ì„±ê³µ í›„) =====
				//updateURLAfterSearch();
				
				
                // ì¶œë ¥ëª¨ì–‘ ë§Œë“¤ê¸°
                let code = '<div class="book-list">';
                
                $.each(res.datas, function(i, book) {
                    
                    // ì´ë¯¸ì§€ ì²˜ë¦¬ (ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€)
                    let bookImage = book.cover_img ? 
                        `<img src="${book.cover_img}" alt="${book.book_title}" class="book-image">` : 
                        `<div class="book-image">ğŸ“–<br>ì´ë¯¸ì§€</div>`;

                    // ê°€ê²© í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
                    let formattedPrice = book.book_price ? 
                        book.book_price.toLocaleString() + 'ì›' : 'ê°€ê²©ì •ë³´ì—†ìŒ';
                    
                    // ë§ˆì¼ë¦¬ì§€ ê³„ì‚° (ì¼ë°˜ì€ 5%ì ë¦½)
                    let mileage = book.book_price ? Math.floor(book.book_price * res.mileageRate) : 0;
                    
					let mileageInfo = ""; // ì¶œë ¥ìš© ë³€ìˆ˜
					if(res.memGrade !== "ë¹„íšŒì›") {
						// ë¡œê·¸ì¸ í•œ íšŒì›
						let ratePercent = (res.mileageRate * 100);
						mileageInfo = `<div class="book-mileage">ì ë¦½ì˜ˆì •: ${mileage.toLocaleString()}ë§ˆì¼ë¦¬ì§€(${ratePercent}%)</div>`;
					} else {
						// ë¹„íšŒì›
						mileageInfo = `<div class="book-mileage non-member">ë¡œê·¸ì¸ í›„ ë§ˆì¼ë¦¬ì§€ ì ë¦½ ê°€ëŠ¥</div>`;
					}

                    // ì¶œê°„ì¼ í¬ë§·
                    let pubDate = book.book_pubdate ? 
                        new Date(book.book_pubdate).toLocaleDateString() : '';
                    
                    code += `
                        <div class="book-item" onclick="goToBookDetail(${book.book_no})">
                            ${bookImage}
                            <div class="book-info">
                                <div class="book-title">${book.book_title}</div>
                                <div class="book-author">${book.book_author}</div>
                                <div class="book-publisher">${book.publisher || ''}</div>
                                <div class="book-publish-date">${pubDate}</div>
                                <div class="book-rating">
									<img id="img-star" src="${mypath}/images/star2.png" alt="${mypath}/images/star2.png">
	                                <span class="stars">${(book.avgRating).toFixed(1)}</span>
	                                <span class="reviewCount">(${book.reviewCount})</span>
                                </div>
                                <div class="book-price">${formattedPrice}</div>
								${mileageInfo}
                            </div>
                            <div class="book-actions">
                                <button class="btn btn-cart">ì¥ë°”êµ¬ë‹ˆ</button>
                                <button class="btn btn-buy">ë°”ë¡œêµ¬ë§¤</button>
                            </div>
                        </div>
                    `;
                });
                
                code += '</div>';
                
                // bookSearch.jspì˜ id="result"ì— ì¶œë ¥
                $('#result').html(code);
                
            } else {
                // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
                
                $('#searchResults').hide();
                $('#noResults').show();
                $('#loading').hide();
            }
            
            // í˜ì´ì§€ ì •ë³´ ì¶œë ¥
            pager = pageList(res.sp, res.ep, res.tp);
            $('#pagelist').html(pager);
        },
        error: function(xhr) {
            $('#loading').hide();
            alert("ì˜¤ë¥˜ : " + xhr.status);
        },
        dataType: 'json'
    });
}


// ìƒˆë¡œê³ ì¹¨í•´ë„ ê·¸ ì „ ê²°ê³¼ê°€ ìœ ì§€ë˜ë„ë¡ URLì— ê²€ìƒ‰ ì¹´í…Œê³ ë¦¬, ê²€ìƒ‰ì–´, ì •ë ¬ê¸°ì¤€ì„ ì €ì¥í•œë‹¤. - 
const updateURLAfterSearch = () => {
	const stype = $('#stype').val();
	/*const sword = $('#sword').val().trim();*/
	const sword = $('#sword').val();
	const sortType = $('#sortType').val();
	
	console.log("update : " + stype + " " + sword + " " + sortType);
	
	if(sword) { // ê²€ìƒ‰ì–´ê°€ ìˆë‹¤ë©´ = ë„ì„œ ë¦¬ìŠ¤íŠ¸ê°€ ì¶œë ¥ëœ ìƒíƒœ - ìƒˆê³  ìœ„í•´ ì €ì¥
		const params = new URLSearchParams();
		params.set('stype', stype);
		params.set('sword', sword);
		params.set('sortType', sortType);
		params.set('currentPage', currentPage);
		
		const newURL = `${window.location.pathname}?${params.toString()}`;
		
		console.log("window.location.href: " + window.location.href);
		console.log("newURL: " + newURL);
		
		// í˜„ì¬ URLê³¼ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
		if(window.location.href != newURL) {
			console.log("ìƒˆë¡œê³ ì¹¨ì´ í˜„ì¬ URLê³¼ ë‹¤ë¥¼ ë•Œ");
			window.history.replaceState({
				stype: stype,
				sword: sword,
				sortType: sortType,
				currentPage: currentPage
			}, '', newURL);
		}
	}
}

// í˜ì´ì§€ë„¤ì´ì…˜
const pageList = (sp, ep, tp) => {

	let pager = `<div class="pagination">`;
	
	// ì´ì „ ë²„íŠ¼
	if(sp > 1 ) {
		pager += `<button class="page-btn prev-btn" data-page="prev">
		             <i class="arrow-left">â€¹</i>
		          </button>`;
	} else {
	    pager += `<button class="page-btn prev-btn disabled">
			         <i class="arrow-left">â€¹</i>
			      </button>`;
	}
	
	// í˜ì´ì§€ ë²ˆí˜¸
	for(i = sp; i <= ep; i++) {
		if(i == currentPage) {  /*currentPage = bookSearch.jspì— ìˆìŒ*/
			pager += `<button class="page-btn page-number active">${i}</button>`;
		} else {
			pager += `<button class="page-btn page-number" data-page="${i}">${i}</button>`;
		}
	} 
	
	// ë‹¤ìŒ ë²„íŠ¼
	if(ep < tp) {
		pager += `<button class="page-btn next-btn" data-page="next">
		             <i class="arrow-right">â€º</i>
		          </button>`;
	}  else {
		 pager += `<button class="page-btn next-btn disabled">
			         <i class="arrow-right">â€º</i>
			       </button>`;
	}
	
	pager += `</div>`;
	
	return pager;
} 


// ì„ íƒí•œ ë„ì„œ ìƒì„¸ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™
const goToBookDetail = (bookNo) => {
	window.location.href = `${mypath}/BookDetail.do?bookNo=${bookNo}`;
}

// ì¥ë°”êµ¬ë‹ˆ insert (ê°€ì˜)
const insertCart = (sendInsertData) => {
	$.ajax({
		url : `${mypath}/InsertCartItem.do`,
		method : 'post',
		data : sendInsertData,
		dataType : 'json',
		
		success : function(res) {
			if (res.flag == "ì„±ê³µ") {
				let result = confirm("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. (íšŒì›)\nì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í• ê¹Œìš”?");
				if (result) {
					window.location.href= mypath+"/cart/cart_page.jsp";
				}
			} else {
				alert("ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤.");
			}
			
		},
		error : function(xhr) {
			console.log(xhr.status);
		}
		
	});
}